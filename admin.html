<!DOCTYPE html>

window.removeFile = function (fileName) {
selectedFiles = selectedFiles.filter(f => f.name !== fileName);
loadPreview();
};

function loadPreview() {
previewArea.innerHTML = '';
selectedFiles.forEach(file => displayPreview(file));
}

// Upload form submission
document.getElementById('upload-form').addEventListener('submit', async (e) => {
e.preventDefault();

if (selectedFiles.length === 0) {
showMessage('error', 'Please select at least one image');
return;
}

const submitBtn = document.getElementById('submit-btn');
submitBtn.disabled = true;
submitBtn.textContent = 'Uploading...';

try {
const productName = document.getElementById('product-name').value;
const category = document.getElementById('product-category').value;
const description = document.getElementById('product-description').value;
const price = document.getElementById('product-price').value;

// Upload images to Supabase Storage
const imageUrls = [];
for (const file of selectedFiles) {
const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
const { data, error } = await storage.upload('product-images', fileName, file);

if (error) throw error;

const publicUrl = storage.getPublicUrl('product-images', fileName);
imageUrls.push(publicUrl);
}

// Save product to Supabase Database
const { data, error } = await db.insert('products', {
name: productName,
category: category,
description: description,
price: parseFloat(price),
images: imageUrls,
image_url: imageUrls[0], // For backward compatibility
active: true,
slug: productName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') + '-' + Date.now()
});

if (error) throw error;

showMessage('success', 'Product uploaded successfully!');

// Reset form
document.getElementById('upload-form').reset();
selectedFiles = [];
previewArea.innerHTML = '';

// Reload products
loadProducts();
} catch (error) {
console.error('Upload error:', error);
showMessage('error', 'Failed to upload product: ' + error.message);
} finally {
submitBtn.disabled = false;
submitBtn.textContent = 'Upload Product';
}
});

// Bulk Import
document.getElementById('bulk-import-btn').addEventListener('click', async () => {
const fileInput = document.getElementById('bulk-file');
const file = fileInput.files[0];
if (!file) {
showMessage('error', 'Please select a JSON file');
return;
}

const btn = document.getElementById('bulk-import-btn');
const progress = document.getElementById('bulk-progress');
btn.disabled = true;
progress.style.display = 'block';
progress.className = 'message';
progress.textContent = 'Reading file...';

const reader = new FileReader();
reader.onload = async (e) => {
try {
const productsData = JSON.parse(e.target.result);
if (!Array.isArray(productsData)) throw new Error('JSON must be an array of products');

let successCount = 0;
let failCount = 0;

for (let i = 0; i < productsData.length; i++) { const p=productsData[i]; progress.textContent=`Importing ${i +
    1}/${productsData.length}...`; try { // Basic validation if (!p.name || !p.price) throw new Error('Missing name or
    price'); const { error }=await db.insert('products', { name: p.name, category: p.category || 'Uncategorized' ,
    description: p.description || '' , price: parseFloat(p.price), image_url: p.image_url || p.image || '' , images:
    p.images || (p.image_url ? [p.image_url] : []), active: true, slug: p.slug ||
    p.name.toLowerCase().replace(/[^a-z0-9]+/g, '-' ).replace(/(^-|-$)/g, '' ) + '-' + Date.now() }); if (error) throw
    error; successCount++; } catch (err) { console.error(`Failed to import ${p.name}:`, err); failCount++; } }
    showMessage('success', `Import complete! Success: ${successCount}, Failed: ${failCount}`); loadProducts();
    fileInput.value='' ; } catch (error) { showMessage('error', 'Invalid JSON file: ' + error.message); } finally {
    btn.disabled=false; progress.style.display='none' ; } }; reader.readAsText(file); }); // Load products async
    function loadProducts() { const loading=document.getElementById('loading'); const
    productsGrid=document.getElementById('products-grid'); loading.classList.add('active'); productsGrid.innerHTML='' ;
    try { const { data: allProducts, error }=await products.getAll(); if (error) throw error; if (!allProducts ||
    allProducts.length===0) {
    productsGrid.innerHTML='<p style="text-align: center; color: #999;">No products yet. Upload your first product!</p>'
    ; } else { allProducts.forEach((product)=> {
    const productCard = createProductCard(product);
    productsGrid.appendChild(productCard);
    });
    }
    } catch (error) {
    console.error('Error loading products:', error);
    showMessage('error', 'Failed to load products');
    } finally {
    loading.classList.remove('active');
    }
    }

    function createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'product-card';
    const image = product.image_url || (product.images && product.images.length > 0 ? product.images[0] :
    'https://placehold.co/400x300?text=No+Image');

    card.innerHTML = `
    <img src="${image}" alt="${product.name}">
    <h3>${product.name}</h3>
    <p style="color: #666; font-size: 14px; margin-bottom: 5px;">${product.category}</p>
    <p style="color: #6b1383; font-weight: bold; font-size: 18px;">â‚¹${product.price}</p>
    <div class="product-actions">
        <button class="btn btn-primary btn-small" onclick="viewProduct('${product.id}')">View</button>
        <button class="btn btn-small" style="background: #dc3545; color: white;"
            onclick="deleteProduct('${product.id}')">Delete</button>
    </div>
    `;
    return card;
    }

    window.viewProduct = function (id) {
    // Implement view/edit functionality
    alert('View/Edit functionality coming soon! ID: ' + id);
    };

    window.deleteProduct = async function (id) {
    if (!confirm('Are you sure you want to delete this product?')) return;

    try {
    const { error } = await db.delete('products', id);

    if (error) throw error;

    showMessage('success', 'Product deleted successfully!');
    loadProducts();
    } catch (error) {
    console.error('Delete error:', error);
    showMessage('error', 'Failed to delete product: ' + error.message);
    }
    };

    function showMessage(type, text) {
    const message = document.getElementById('message');
    message.className = `message ${type}`;
    message.textContent = text;
    message.style.display = 'block';

    setTimeout(() => {
    message.style.display = 'none';
    }, 5000);
    }
    </script>
    </body>

    </html>